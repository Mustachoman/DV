<html>
    <head>
        <meta charset="utf-8">
        <link rel="shortcut icon" type="image/png" href="favicon.ico"/>
        <link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet"> 
        <title>Starbucks Index</title>
        <script src="Assets/geomap/vendor/d3.geomap.dependencies.min.js"></script>
        <script src="Assets/topojson.min.js"></script>
        <script src="Assets/datamaps.world.hires.min.js"></script>
        <style type="text/css">
            @font-face { font-family: Lato; src: url('Assets/Fonts/Lato-Regular.ttf'); } 

            p {
                font-family: Lato
            }
        </style>
    </head>
    <body>
        <div id="header" style="height:179px; width:225px; left:calc(50% - 112.5px); position:relative;">
            <img src="Assets/Images/logo.jpg" style="height:100%; width:100%;">
            <p>How western is your country?</p>
        </div>
        <div id="map" style="position: relative; width: 1000; height: 750; left:calc(50% - 500px); position:relative;"></div>
        <script type="text/javascript">
            var allStores;
            var countryCodes;
            var countryCount = {};
            var paletteScale;
            var dataset = {};
            
            var map = new Datamap({element: document.getElementById('map'),
                geographyConfig: {
                    popupTemplate: function(geography, data) {
                        return '<div class="hoverinfo"><b>' + geography.properties.name + '</b></br>' + 'Amount of Starbucks stores:' +  data.amount + '</div>'
                    }
                },
                fills: {
                    defaultFill: '#efe5de' 
                },
                projection: 'mercator'
            });
            
            d3.csv("Data/starbucks-stores.csv", function(data) {
                allStores = data;
            });

            d3.csv("Data/country-codes.csv", function(data) {
                countryCodes = data;
            });

            var loadInterval = setInterval(setCountryCodes, 1000);

            function setCountryCodes(){
                console.log('Loading...');
                if (allStores !== undefined && countryCodes !== undefined){
                    for(store in allStores){
                        var oldCountryCode = allStores[store]['Country'];
                        var newCountryCode = '';
                        for(country in countryCodes){
                            if (countryCodes[country]['ISO3166-1-Alpha-2'] == oldCountryCode){
                                newCountryCode = countryCodes[country]['ISO3166-1-Alpha-3'];
                            }
                        }
                        allStores[store]['Country3'] = newCountryCode;
                    }
                    console.log('Done!');
                    countStores();
                    clearInterval(loadInterval);
                }
            }

            function countStores(){
                var max = 1;
                var min = 1;
                for(store in allStores){
                    count = countryCount[allStores[store]['Country3']];
                    if(count){
                        count++;
                        if(count > max){
                            max = count;
                        }
                        if (count < min){
                            min = count;
                        }
                        countryCount[allStores[store]['Country3']] = count;
                    }
                    else countryCount[allStores[store]['Country3']] = 1;
                }
                setColours(min,max);
            }

            function setColours(min, max){
                var paletteScale = d3.scale.log()
                    .domain([min,max])
                    .range(["#efffef","#00713D"]); 
                updateMap(paletteScale);
            }

            function updateMap(palette){
                for(country in countryCount){
                    var iso = country,
                        value = countryCount[country];
                    dataset[iso] = { amount: value, fillColor: palette(value) };
                }
                map.updateChoropleth(dataset);
            }
        </script>
    </body>
</html>
